# 4. Windows Service Permissions Management

This document explains how to manage Windows service permissions using batch commands and understand the SDDL (Security Descriptor Definition Language) format.

<br />

---

<br />

- [4. Windows Service Permissions Management](#4-windows-service-permissions-management)
  - [Quick Commands](#quick-commands)
    - [Check Service Permissions](#check-service-permissions)
    - [Example: Check Microsoft Passport Service](#example-check-microsoft-passport-service)
  - [Batch Scripts](#batch-scripts)
    - [1. Check Service Permissions (Simple)](#1-check-service-permissions-simple)
    - [2. Check Service Permissions (Advanced with PowerShell)](#2-check-service-permissions-advanced-with-powershell)
    - [3. Grant Service Permissions (Template)](#3-grant-service-permissions-template)
  - [SDDL (Security Descriptor Definition Language) Reference](#sddl-security-descriptor-definition-language-reference)
    - [Structure](#structure)
    - [ACE (Access Control Entry) Format](#ace-access-control-entry-format)
    - [AceType](#acetype)
    - [Rights (Service-Specific)](#rights-service-specific)
    - [Common Rights Combinations](#common-rights-combinations)
    - [Security Principals](#security-principals)
    - [Example SDDL Breakdown](#example-sddl-breakdown)
  - [Common Service Names](#common-service-names)
  - [Usage Examples](#usage-examples)
    - [Check Microsoft Passport Service Permissions](#check-microsoft-passport-service-permissions)
    - [Check Windows Update Service Permissions](#check-windows-update-service-permissions)
    - [Save to File](#save-to-file)
  - [Notes](#notes)
  - [Troubleshooting](#troubleshooting)
    - [Common Error Codes](#common-error-codes)
    - [Getting Service Names](#getting-service-names)
    - [Getting Service Display Names](#getting-service-display-names)

<br />

---

<br />

## Quick Commands

Use the following commands to view / manage service permissions:

<br />

### Check Service Permissions

```batch
sc sdshow ServiceName
```

<br />

### Example: Check Microsoft Passport Service

```batch
sc sdshow NgcSvc
```

<br />

---

<br />

## Batch Scripts

The following scripts allow you to modify existing service permissions for a user and grant them the ability to manage a service (start, stop, etc).

<br />

### 1. Check Service Permissions (Simple)

```batch
@echo off
set servicename=%1
if "%servicename%"=="" set servicename=ServiceName

echo Checking permissions for service: %servicename%
echo.
echo Security descriptor for %servicename%:
sc sdshow %servicename%

echo.
echo Common SDDL abbreviations:
echo SY = SYSTEM
echo BA = Built-in Administrators
echo AU = Authenticated Users
echo PU = Power Users
echo BU = Built-in Users
echo.
pause
```

<br />

### 2. Check Service Permissions (Advanced with PowerShell)

```batch
@echo off
set servicename=%1
if "%servicename%"=="" set servicename=ServiceName

echo Checking permissions for service: %servicename%

powershell -NoProfile -ExecutionPolicy Bypass -Command "6 {
    $serviceName = '%servicename%'
    $sddl = (sc.exe sdshow $serviceName)[1]
    Write-Host 'Raw SDDL:' $sddl
    Write-Host ''
    if (Get-Command ConvertFrom-SddlString -ErrorAction SilentlyContinue) {
        Write-Host 'Decoded permissions:'
        $permissions = ConvertFrom-SddlString -Sddl $sddl
        $permissions.DiscretionaryAcl | Format-Table -AutoSize
    } else {
        Write-Host 'ConvertFrom-SddlString not available. Raw SDDL shown above.'
    }
}"

pause
```

<br />

### 3. Grant Service Permissions (Template)

```batch
@echo off
echo Granting service permissions...

:: Define service and user
set servicename=ServiceName
set username=DOMAIN\Username

:: Get current security descriptor
for /f "tokens=2 delims= " %%a in ('sc sdshow %servicename%') do set currentsd=%%a

:: Grant full control permissions to service
:: Note: Must construct the proper SDDL string
sc sdset %servicename% "D:(A;;CCLCSWRPWPDTLOCRRC;;;SY)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCLCSWLOCRRC;;;AU)(A;;CCLCSWRPWPDTLOCRRC;;;PU)(A;;RPWPCRDTLORCSDRCWDWO;;;%username%)"

if %errorlevel% equ 0 (
    echo Permissions granted successfully.
) else (
    echo Failed to grant permissions. Error code: %errorlevel%
)

pause
```

<br />

---

<br />

## SDDL (Security Descriptor Definition Language) Reference

This section explains the format used when modifying permissions for a service, and a list of what each group of permissions means.

<br />

### Structure

An SDDL string has the following format:
```
D:(ace1)(ace2)(ace3)...S:(ace1)(ace2)...
```

- **D:** = Discretionary Access Control List (DACL) - who can access what
- **S:** = System Access Control List (SACL) - auditing information

<br />

### ACE (Access Control Entry) Format

```
(AceType;;Rights;;;SecurityPrincipal)
```

<br />

### AceType

| Code | Description |
|------|-------------|
| A    | Allow access |
| D    | Deny access |
| AU   | Audit (both success and failure) |
| AL   | Audit (success only) |
| AF   | Audit (failure only) |

<br />

### Rights (Service-Specific)

| Code | Description |
|------|-------------|
| CC   | Query Configuration |
| DC   | Change Configuration |
| LC   | Query Status |
| SW   | Enumerate Dependencies |
| RP   | Start Service |
| WP   | Stop Service |
| DT   | Pause/Continue Service |
| LO   | Interrogate Service |
| CR   | User-Defined Control |
| SD   | Delete Service |
| RC   | Read Security Descriptor |
| WD   | Write Security Descriptor |
| WO   | Write Owner |

<br />

### Common Rights Combinations

| Combination | Description |
|-------------|-------------|
| CCDCLCSWRPWPDTLOCRSDRCWDWO | Full Control |
| CCDCLCSWRPWPDTLOCRRC | Read/Execute |
| RPWPCR | Start/Stop Service |

<br />

### Security Principals

| Code | Description |
|------|-------------|
| SY   | Local System |
| BA   | Built-in Administrators |
| AU   | Authenticated Users |
| PU   | Power Users |
| BU   | Built-in Users |
| WD   | Everyone |
| AN   | Anonymous |
| IU   | Interactive Users |
| NU   | Network Users |
| S-1-5-... | Specific user/group SID |

<br />

### Example SDDL Breakdown

```
D:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-xxx-1001)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;AU)S:(AU;FA;CCDCLCSWRPWPDTLOSDRCWDWO;;;WD)
```

**DACL Section:**
1. `(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)` - Allow Built-in Administrators full control
2. `(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-xxx-1001)` - Allow specific user (SID) full control
3. `(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;AU)` - Allow Authenticated Users full control

**SACL Section:**
1. `(AU;FA;CCDCLCSWRPWPDTLOSDRCWDWO;;;WD)` - Audit all access attempts by Everyone

<br />

---

<br />

## Common Service Names

The following is a list of common services for Microsoft Windows

<br />

| Display Name | Service Name |
|--------------|-------------|
| Microsoft Passport | NgcSvc |
| Windows Update | wuauserv |
| Print Spooler | Spooler |
| Windows Defender | WinDefend |
| BITS | BITS |
| Task Scheduler | Schedule |
| Windows Time | W32Time |

<br />

---

<br />

## Usage Examples

These examples show how to check service permissions:

<br />

### Check Microsoft Passport Service Permissions

```batch
sc sdshow NgcSvc
```

<br />

### Check Windows Update Service Permissions

```batch
sc sdshow wuauserv
```

<br />

### Save to File

```batch
sc sdshow NgcSvc > service_permissions.txt
```

<br />

---

<br />

## Notes

- Always run these commands with administrator privileges
- Modifying service permissions can affect system stability
- Test changes in a controlled environment first
- Consider using the Service Security Editor tool for complex permission changes
- Some services are protected and may require additional steps to modify

<br />

---

<br />

## Troubleshooting

Common issues that may occur and how to solve them:

<br />

### Common Error Codes

- **5**: Access Denied - Run as administrator
- **1060**: Service does not exist - Check service name
- **1072**: Service marked for deletion - Restart required

<br />

### Getting Service Names

```batch
sc query | findstr "SERVICE_NAME"
```

<br />

### Getting Service Display Names

```batch
sc query | findstr "DISPLAY_NAME"
```

